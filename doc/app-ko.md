# 애플리케이션 문서 (app.py)

## 개요

메인 Streamlit 애플리케이션(`app.py`)은 선박 소화 규칙 챗봇을 위한 대화형 웹 인터페이스를 제공합니다. AWS Bedrock Agent와 통합하여 선박 소화 규정에 대한 지능적인 응답을 제공합니다.

## 주요 기능

### 1. Streamlit 웹 인터페이스
- **페이지 구성**: 선박 이모지(🚢)와 와이드 레이아웃으로 구성
- **한국어 지원**: 완전한 한국어 인터페이스
- **반응형 디자인**: 다양한 화면 크기에 최적화

### 2. AWS 통합
- **Bedrock Agent Runtime**: 지능적인 응답을 위한 AWS Bedrock Agent 연결
- **S3 클라이언트**: 원본 문서 이미지 다운로드 및 표시
- **세션 관리**: UUID 기반 세션을 사용한 대화 컨텍스트 유지

### 3. 참조 시스템
- **문서 참조**: 소스 문서 정보 추출 및 표시
- **OCR 텍스트 표시**: PDF 문서에서 추출된 텍스트 표시
- **이미지 뷰어**: S3의 원본 PDF 페이지 이미지 표시
- **메타데이터 정보**: 페이지 번호를 포함한 문서 메타데이터 제공

## 핵심 구성 요소

### AWS 클라이언트 초기화
```python
@st.cache_resource
def get_bedrock_client():
    return boto3.client('bedrock-agent-runtime', region_name='us-west-2')

@st.cache_resource
def get_s3_client():
    return boto3.client('s3', region_name='us-west-2')
```

### 세션 상태 관리
- `messages`: 대화 기록 저장
- `session_id`: 각 채팅 세션의 고유 식별자

### 참조 처리
애플리케이션은 Bedrock Agent의 추적 이벤트를 처리하여 다음을 추출합니다:
- 소스 파일명
- 페이지 번호
- OCR 추출 텍스트
- S3 이미지 URI

## 사용자 인터페이스 구성 요소

### 메인 채팅 인터페이스
- **채팅 입력**: 사용자 질의를 위한 텍스트 입력
- **메시지 표시**: 역할 기반 스타일링으로 대화 기록 표시
- **참조 링크**: 응답에서 클릭 가능한 참조 번호

### 참조 표시
- **확장 가능한 섹션**: 접을 수 있는 확장기에 각 참조 표시
- **OCR 텍스트 영역**: 추출된 내용을 보여주는 스크롤 가능한 텍스트 영역
- **이미지 표시**: 줌 기능이 있는 전체 너비 이미지 표시
- **메타데이터 JSON**: 문서 정보의 구조화된 표시

### 사이드바 정보
- **세션 정보**: 현재 세션 ID 및 메시지 수
- **새 세션 버튼**: 대화를 재설정하고 새 세션 ID 생성
- **지원 주제**: 사용 가능한 질의 주제 목록
- **사용 지침**: 시스템 사용 방법에 대한 간단한 가이드

## 구성

### AWS 리소스
- **Agent ID**: `H5YNZKKNSW`
- **Agent Alias ID**: `FD3LV7TEN4`
- **리전**: `us-west-2`

### Streamlit 구성
- **페이지 제목**: "선박 Firefighting 규칙 챗봇"
- **페이지 아이콘**: 🚢
- **레이아웃**: 더 나은 콘텐츠 표시를 위한 와이드 모드

## 오류 처리

### S3 이미지 로딩
- 누락되거나 접근할 수 없는 이미지의 우아한 처리
- 사용자 친화적인 오류 메시지
- 이미지 실패 시 텍스트 전용 표시로 폴백

### Agent 통신
- Bedrock Agent API 호출에 대한 예외 처리
- 사용자에게 오류 메시지 표시
- 개별 요청 실패에도 불구하고 서비스 지속

## 성능 최적화

### 캐싱
- `@st.cache_resource`를 사용한 AWS 클라이언트 캐싱
- 반복적인 클라이언트 초기화 방지
- 응답 시간 개선

### 스트리밍 응답
- Agent 응답의 실시간 표시
- 참조 정보의 점진적 로딩
- 즉각적인 피드백으로 향상된 사용자 경험

## 사용 예시

### 기본 질의
```
사용자: "선박 설계시 firefighting 규칙에 대해 알려주세요"
시스템: [Bedrock Agent를 통해 질의 처리]
응답: [참조가 포함된 상세한 답변]
```

### 참조 상호작용
1. 사용자가 참조 번호 [1], [2] 등이 포함된 응답을 받음
2. 응답 아래 확장 가능한 섹션에 참조 표시
3. 각 참조는 OCR 텍스트와 원본 이미지를 보여줌
4. 메타데이터는 추가 문서 컨텍스트 제공

## 문제 해결

### 일반적인 문제
1. **AWS 자격 증명**: 적절한 AWS 구성 확인
2. **리전 설정**: us-west-2 리전 액세스 확인
3. **Agent 권한**: Bedrock Agent 액세스 권한 확인
4. **S3 액세스**: S3 버킷 읽기 권한 확인

### 디버그 정보
- 추적을 위해 사이드바에 세션 ID 표시
- 인터페이스에 직접 오류 메시지 표시
- 개발 디버깅을 위한 콘솔 로깅

## 향후 개선사항

### 계획된 기능
- 다국어 응답 지원
- 고급 검색 필터
- 문서 업로드 기능
- 대화 기록 내보내기
- 향상된 참조 링크 시스템